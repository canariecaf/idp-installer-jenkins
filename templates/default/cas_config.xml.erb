<?xml version='1.0' encoding='UTF-8'?>
<matrix-project plugin="matrix-project@1.4">
  <actions/>
  <description>Tests the installer using CAS for authentication.</description>
  <keepDependencies>false</keepDependencies>
  <properties>
    <com.coravy.hudson.plugins.github.GithubProjectProperty plugin="github@1.10">
      <projectUrl>https://github.com/cybera/idp-installer-CAF/</projectUrl>
    </com.coravy.hudson.plugins.github.GithubProjectProperty>
  </properties>
  <scm class="hudson.plugins.git.GitSCM" plugin="git@2.3.1">
    <configVersion>2</configVersion>
    <userRemoteConfigs>
      <hudson.plugins.git.UserRemoteConfig>
        <url>https://github.com/cybera/idp-installer-CAF</url>
        <credentialsId>a364be1e-1c31-4c2b-9832-3f147479a905</credentialsId>
      </hudson.plugins.git.UserRemoteConfig>
    </userRemoteConfigs>
    <branches>
      <hudson.plugins.git.BranchSpec>
        <name>refs/heads/master</name>
      </hudson.plugins.git.BranchSpec>
    </branches>
    <doGenerateSubmoduleConfigurations>false</doGenerateSubmoduleConfigurations>
    <submoduleCfg class="list"/>
    <extensions/>
  </scm>
  <canRoam>true</canRoam>
  <disabled>false</disabled>
  <blockBuildWhenDownstreamBuilding>false</blockBuildWhenDownstreamBuilding>
  <blockBuildWhenUpstreamBuilding>false</blockBuildWhenUpstreamBuilding>
  <triggers/>
  <concurrentBuild>false</concurrentBuild>
  <axes>
    <hudson.matrix.LabelAxis>
      <name>label</name>
      <values>
        <string>centos6</string>
      </values>
    </hudson.matrix.LabelAxis>
  </axes>
  <builders>
    <hudson.tasks.Shell>
      <command>sudo sh -c &quot;echo &apos;<%= node[:idp_installer_jenkins][:ldap_ip] %> <%= node[:idp_installer_jenkins][:ldap_host] %>&apos; &gt;&gt; /etc/hosts&quot;
sudo sh -c &quot;echo &apos;<%= node[:idp_installer_jenkins][:cas_ip] %> <%= node[:idp_installer_jenkins][:cas_host] %>&apos; &gt;&gt; /etc/hosts&quot;
sudo sed -i &apos;/^127.0.0.1/ s/$/ idp-test.shibtest.cybera.ca sp-test.shibtest.cybera.ca/&apos; /etc/hosts
sudo -i $WORKSPACE/deploy_idp.sh</command>
    </hudson.tasks.Shell>
    <org.jenkinsci.plugins.configfiles.builder.ConfigFileBuildStep plugin="config-file-provider@2.7.5">
      <managedFiles>
        <org.jenkinsci.plugins.configfiles.buildwrapper.ManagedFile>
          <fileId>org.jenkinsci.plugins.configfiles.custom.CustomConfig1418429106314</fileId>
          <targetLocation>relying-party.xml.diff</targetLocation>
          <variable></variable>
        </org.jenkinsci.plugins.configfiles.buildwrapper.ManagedFile>
      </managedFiles>
    </org.jenkinsci.plugins.configfiles.builder.ConfigFileBuildStep>
    <hudson.tasks.Shell>
      <command>sudo /sbin/iptables -t nat -I OUTPUT -p tcp -o lo --dport 443 -j REDIRECT --to-ports 7443
sudo wget --no-check-certificate https://localhost:9443/Shibboleth.sso/Metadata -O /opt/shibboleth-idp/metadata/sp-metadata.xml
sudo patch /opt/shibboleth-idp/conf/relying-party.xml &lt; relying-party.xml.diff
sleep 60
sudo /sbin/service tomcat6 restart
sleep 60
sudo wget --no-check-certificate https://localhost/idp/shibboleth -O /etc/shibboleth/partner-metadata.xml
sudo /sbin/service shibd restart</command>
    </hudson.tasks.Shell>
    <org.jenkinsci.plugins.configfiles.builder.ConfigFileBuildStep plugin="config-file-provider@2.7.5">
      <managedFiles>
        <org.jenkinsci.plugins.configfiles.buildwrapper.ManagedFile>
          <fileId>org.jenkinsci.plugins.configfiles.custom.CustomConfig1418841925421</fileId>
          <targetLocation>test_cas.py</targetLocation>
          <variable></variable>
        </org.jenkinsci.plugins.configfiles.buildwrapper.ManagedFile>
      </managedFiles>
    </org.jenkinsci.plugins.configfiles.builder.ConfigFileBuildStep>
    <hudson.tasks.Shell>
      <command>sudo yum install python-pip -y
sudo pip install selenium
xvfb-run python test_cas.py</command>
    </hudson.tasks.Shell>
  </builders>
  <publishers>
    <hudson.tasks.Mailer plugin="mailer@1.12">
      <recipients>cameron.mann@cybera.ca</recipients>
      <dontNotifyEveryUnstableBuild>false</dontNotifyEveryUnstableBuild>
      <sendToIndividuals>true</sendToIndividuals>
    </hudson.tasks.Mailer>
  </publishers>
  <buildWrappers>
    <org.jenkinsci.plugins.configfiles.buildwrapper.ConfigFileBuildWrapper plugin="config-file-provider@2.7.5">
      <managedFiles>
        <org.jenkinsci.plugins.configfiles.buildwrapper.ManagedFile>
          <fileId>org.jenkinsci.plugins.configfiles.custom.CustomConfig1418080695436</fileId>
          <targetLocation>config</targetLocation>
          <variable></variable>
        </org.jenkinsci.plugins.configfiles.buildwrapper.ManagedFile>
      </managedFiles>
    </org.jenkinsci.plugins.configfiles.buildwrapper.ConfigFileBuildWrapper>
    <jenkins.plugins.jclouds.compute.JCloudsOneOffSlave plugin="jclouds-jenkins@2.8"/>
  </buildWrappers>
  <executionStrategy class="hudson.matrix.DefaultMatrixExecutionStrategyImpl">
    <runSequentially>false</runSequentially>
  </executionStrategy>
</matrix-project>
